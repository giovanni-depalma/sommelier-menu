---
import Layout from "../layouts/Layout.astro";
import wines from "../data/wines";

import type { WineItem } from "../types";

import QRCode from "qrcode";

// Group wines by type
const categories: Record<string, WineItem[]> = {
    Bollicine: [],
    Bianchi: [],
    Rosati: [],
    Rossi: [],
    "Passiti/Distillati": [],
};

wines.forEach((wine) => {
    if (categories[wine.type]) {
        categories[wine.type].push(wine);
    }
});

const fullUrl = new URL(Astro.url.pathname, Astro.site).href;
const qrCodeUrl = await QRCode.toDataURL(fullUrl, { width: 150 });
---

<Layout title="Carta dei Vini - Restaurante Fusi√≥n">
    <header class="page-header">
        <h1>Carta dei Vini</h1>
        <a href={import.meta.env.BASE_URL} class="back-link"
            >‚Üê Torna alla Home</a
        >
        <a
            href={`${import.meta.env.BASE_URL}/wines.pdf`}
            class="back-link"
            download>üìÑ Scarica PDF</a
        >
    </header>

    <div class="content-container" id="wines-container">
        {
            Object.entries(categories).map(([type, wineList]) => {
                if (wineList.length === 0) return null;
                return (
                    <section class="category-section">
                        <h2 class="category-title">{type}</h2>
                        {wineList.map((wine) => (
                            <div class="item-card wine-item-card">
                                <div class="item-info">
                                    <div class="item-header">
                                        <h3 class="item-name">
                                            <a
                                                href={`${import.meta.env.BASE_URL}/wines/${wine.id}`}
                                                class="wine-link"
                                            >
                                                {wine.name}
                                            </a>
                                        </h3>
                                        <span class="item-denomination">
                                            {wine.denomination}
                                        </span>
                                    </div>
                                    <div class="wine-item">
                                        <div class="wine-details">
                                            <span class="wine-producer">
                                                {wine.producer}
                                            </span>
                                            <span class="wine-region">
                                                {wine.region}, {wine.country}
                                            </span>
                                            <span class="wine-vintage">
                                                {wine.vintage}
                                            </span>
                                        </div>
                                    </div>
                                    <p class="item-desc">{wine.description}</p>
                                    <p class="item-meta">{wine.grape}</p>
                                </div>
                            </div>
                        ))}
                    </section>
                );
            })
        }
    </div>

    <div class="print-only">
        <img src={qrCodeUrl} alt="QR Code Carta dei Vini" />
        <p>Scansiona per vedere la carta dei vini online</p>
    </div>
</Layout>

<style>
    .wine-link {
        color: inherit;
        text-decoration: none;
        border-bottom: 1px dotted #999;
        transition: all 0.2s;
    }

    .wine-link:hover {
        border-bottom: 1px solid #333;
        color: #000;
    }

    @media print {
        .wine-link {
            text-decoration: none;
            border-bottom: none;
            color: black;
        }
    }
</style>
