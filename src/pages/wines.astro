---
import Layout from "../layouts/Layout.astro";
import wines from "../data/wines";
import QRCode from "qrcode";
import PdfCover from "../components/PdfCover.astro";
import WineCard from "../components/WineCard.astro";
import {
    groupWinesByTypeCountryRegion,
    getSortedCountries,
} from "../utils/wineGrouping";

// Group wines using utility function
const categories = groupWinesByTypeCountryRegion(wines);

const fullUrl = new URL(Astro.url.pathname, Astro.site).href;
const qrCodeUrl = await QRCode.toDataURL(fullUrl, { width: 150 });
---

<Layout title="Carta dei Vini - Restaurante Fusi√≥n">
    <PdfCover
        qrCodeUrl={qrCodeUrl}
        title="Carta dei Vini"
        description="Esplora la nostra selezione di vini pregiati, curata con passione per accompagnare i tuoi momenti speciali."
    />
    <header class="page-header">
        <h1>Carta dei Vini</h1>
        <a href={import.meta.env.BASE_URL} class="back-link"
            >‚Üê Torna alla Home</a
        >
        <a
            href={`${import.meta.env.BASE_URL}/wines.pdf`}
            class="back-link"
            download>üìÑ Scarica PDF</a
        >
    </header>

    <div class="content-container" id="wines-container">
        {
            Object.entries(categories).map(([type, countryMap]) => {
                const sortedCountries = getSortedCountries(countryMap);
                if (sortedCountries.length === 0) return null;

                return (
                    <section class="category-section">
                        <h2 class="category-title">{type}</h2>

                        {sortedCountries.map((country) => {
                            const data = countryMap[country];
                            const hasRegions =
                                Object.keys(data.regions).length > 0;

                            if (!hasRegions) return null;

                            return (
                                <div class="country-section">
                                    <h3 class="country-title">{country}</h3>

                                    {/* Render Regions for all countries */}
                                    {Object.keys(data.regions)
                                        .sort()
                                        .map((region) => (
                                            <div class="region-group">
                                                <h4 class="region-title">
                                                    {region}
                                                </h4>
                                                {data.regions[region].map(
                                                    (wine) => (
                                                        <WineCard wine={wine} />
                                                    ),
                                                )}
                                            </div>
                                        ))}
                                </div>
                            );
                        })}
                    </section>
                );
            })
        }
    </div>
</Layout>

<style>
    .country-section {
        margin-bottom: 3rem;
        padding-left: 1rem;
    }

    .country-title {
        font-family: var(--font-heading);
        font-size: 1.6rem;
        color: #444;
        margin-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 0.5rem;
    }

    .region-group {
        margin-bottom: 2rem;
        padding-left: 1rem;
    }

    .region-title {
        font-family: var(--font-accent);
        font-size: 1.3rem;
        color: var(--gold);
        margin-bottom: 1rem;
        font-weight: 600;
    }

    @media print {
        .country-title {
            font-size: 1.4rem;
            border-bottom: 1px solid #000;
            margin-top: 1.5rem;
        }

        .region-title {
            font-size: 1.2rem;
            color: #333;
            margin-top: 1rem;
        }

        .country-section,
        .region-group {
            padding-left: 0;
            margin-bottom: 1rem;
        }
    }
</style>
